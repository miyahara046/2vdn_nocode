<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Name="Page"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:_2vdm_spec_generator.ViewModel"
             xmlns:converters="clr-namespace:_2vdm_spec_generator.Converters"
             x:Class="_2vdm_spec_generator.NoCodePage"
             x:DataType="vm:NoCodePageViewModel"
             Title="NoCode">

    <ContentPage.Resources>
        <ResourceDictionary>
            <vm:LevelToIndentConverter x:Key="LevelToIndentConverter"/>
            <vm:BoolToExpandCollapseConverter x:Key="BoolToExpandCollapseConverter"/>
            <vm:SelectedToColorConverter x:Key="SelectedToColorConverter"/>
            <converters:ScreenTypeToVisibilityConverter x:Key="ScreenTypeToVisibilityConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.MenuBarItems>
        <MenuBarItem Text="ファイル">
            <MenuFlyoutItem Text="フォルダを選択" Command="{Binding SelectFolderCommand}"/>
            <MenuFlyoutItem Text="新規ファイル作成" Command="{Binding CreateNewMdFileCommand}"/>
        </MenuBarItem>
        <MenuBarItem Text="変換">
            <MenuFlyoutItem Text="VDM++に変換" Command="{Binding ConvertToVdmCommand}"/>
            <MenuFlyoutItem Text="保存" Command="{Binding SaveMarkdownCommand}"/>
        </MenuBarItem>
    </ContentPage.MenuBarItems>

    <Grid RowDefinitions="0.15*,0.85*" ColumnDefinitions="1*,3*,2*">

        <!-- 上部操作ボタン -->
        <ScrollView Grid.Row="0" Grid.ColumnSpan="3" Orientation="Horizontal" Padding="10">
            <HorizontalStackLayout Spacing="15" VerticalOptions="Center">
                <Button Text="スタートページに戻る" Command="{Binding GoToStartPageCommand}" />
                <Button Text="フォルダの選択" Command="{Binding SelectFolderCommand}" IsVisible="{Binding IsFolderSelected}" />
                <Button Text="クラスの種類選択・追加" Command="{Binding AddClassHeadingCommand}" IsVisible="{Binding IsClassAddButtonVisible}"/>
                <Button Text="画面の追加" Command="{Binding AddScreenListCommand}" IsVisible="{Binding IsScreenListAddButtonVisible}"/>
                <Button Text="ボタンの追加" Command="{Binding AddBottonCommand}" IsVisible="{Binding IsClassAllButtonVisible}"/>
                <Button Text="イベントの追加" Command="{Binding AddEventCommand}" IsVisible="{Binding IsClassAllButtonVisible}"/>
                <Button Text="タイムアウトの追加" Command="{Binding AddTimeoutEventCommand}" IsVisible="{Binding IsClassAllButtonVisible}"/>
                <Button Text="クラス名（画面名）の変更" Command="{Binding RenameClassCommand}" IsVisible="{Binding IsClassAllButtonVisible}"/>
                <Button Text="削除" Command="{Binding DeleteSelectedGuiElementCommand}"/>
            </HorizontalStackLayout>
        </ScrollView>

        <!-- 左側：ファイル一覧 -->
        <Border Grid.Row="1" Grid.Column="0" Stroke="Gray" StrokeThickness="1" Padding="5" Margin="5">
            <CollectionView ItemsSource="{Binding FolderItems}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedItem, Mode=TwoWay}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:FolderItem">
                        <HorizontalStackLayout Padding="0,2"
                                               IsVisible="{Binding IsVisible}"
                                               Spacing="2"
                                               BackgroundColor="{Binding ., Converter={StaticResource SelectedToColorConverter}, ConverterParameter={x:Reference Page}}">
                            <HorizontalStackLayout.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:NoCodePageViewModel}}, Path=SelectItemCommand}"
                                                      CommandParameter="{Binding}" />
                            </HorizontalStackLayout.GestureRecognizers>

                            <!-- フォルダ折りたたみラベル-->
                            <Label Text="{Binding IsExpanded, Converter={StaticResource BoolToExpandCollapseConverter}}"
                                   IsVisible="{Binding IsFolder}"
                                   FontSize="15"
                                   VerticalOptions="Center"
                                   TextColor="Black">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:NoCodePageViewModel}}, Path=ToggleExpandCommand}"
                                                          CommandParameter="{Binding}" />
                                </Label.GestureRecognizers>
                            </Label>

                            <!-- ファイル / フォルダ名-->
                            <Label Text="{Binding Name}"
                                   VerticalOptions="Center"
                                   Padding="{Binding Level, Converter={StaticResource LevelToIndentConverter}}"
                                   HorizontalOptions="FillAndExpand" />
                        </HorizontalStackLayout>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

        </Border>

        <!-- 中央：GUI表示（ダイアグラム） -->
        <Border Grid.Row="1" Grid.Column="1" Stroke="Gray" StrokeThickness="1" Padding="10" Margin="5">
            <Grid RowDefinitions="Auto,*">
                <!-- ここをバインドに変更 -->
                <Label Text="{Binding DiagramTitle}" FontSize="16" FontAttributes="Bold" Margin="0,0,0,5"/>

                <!-- ScrollView を縦横スクロール可能に変更 -->
                <ScrollView Grid.Row="1" VerticalOptions="FillAndExpand" HorizontalOptions="FillAndExpand" Orientation="Both">
                    <!-- コンテナは横幅がコンテンツに合わせて決まるように Start にする -->
                    <ContentView x:Name="DiagramContainer"
                                 BackgroundColor="WhiteSmoke"
                                 VerticalOptions="Start"
                                 HorizontalOptions="Start"/>
                </ScrollView>
            </Grid>
        </Border>


        <!-- 右側：VDM++ 表示 -->
        <Border Grid.Row="1" Grid.Column="2" Stroke="Gray" StrokeThickness="1" Padding="10" Margin="5">
            <Grid RowDefinitions="Auto,*">
                <Label Text="VDM++" FontSize="16" FontAttributes="Bold" Margin="0,0,0,5"/>
                <!-- Editor を ScrollView でラップして縦スクロールを有効にする -->
                <ScrollView Grid.Row="1"
                            Orientation="Vertical"
                            VerticalOptions="FillAndExpand"
                            HorizontalOptions="FillAndExpand">
                    <Editor
                        Text="{Binding VdmContent}"
                        IsReadOnly="True"
                        Margin="0"
                        VerticalOptions="Start"
                        HorizontalOptions="FillAndExpand"
                        AutoSize="TextChanges" />
                </ScrollView>
            </Grid>
        </Border>
    </Grid>
</ContentPage>

